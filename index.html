<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Global Supply Control Tower | JS KIM (v13.9-GAS)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary: #0A2647;
            --accent: #1597BB;
            --current: #1A1A1B;
            --future: #D35400;
            --bg: #F0F5F9;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        #layout { display: flex; height: 100vh; width: 100vw; position: relative; }
        #map { flex-grow: 1; height: 100%; background: #0b192e; z-index: 1; }
        #sidebar { position: absolute; left: 0; top: 0; width: 320px; height: 100%; background: white; z-index: 2000; transition: transform 0.4s ease; box-shadow: 5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #sidebar.hidden { transform: translateX(-100%); }
        #toggle-btn { position: absolute; right: -45px; top: 20px; width: 45px; height: 45px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 0 8px 8px 0; font-size: 18px; z-index: 2001; }
        .header { background: var(--primary); color: white; padding: 25px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative; }
        .created-by { font-size: 1.1rem; color: #FFD700; font-weight: 900; display: block; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin-bottom: 15px; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 5px; }
        #data-mode { position: absolute; right: 20px; bottom: 20px; font-size: 0.65rem; font-weight: 900; padding: 4px 10px; border-radius: 12px; background: #95a5a6; color: white; cursor: pointer; z-index: 2002; }
        .product-tabs { display: flex; background: #051937; padding: 5px; gap: 4px; }
        .tab-btn { flex: 1; padding: 12px 2px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-weight: bold; font-size: 0.75rem; border-radius: 4px; }
        .tab-btn.active { background: var(--accent); color: white; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; background: var(--accent); color: white; gap: 1px; }
        .metric-box { padding: 10px; background: var(--accent); text-align: center; }
        .metric-value { font-size: 1.15rem; font-weight: 900; }
        #list-container { flex-grow: 1; overflow-y: auto; background: var(--bg); }
        .group-header { padding: 14px 12px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 0.85rem; align-items: center; }
        .region-header { background: #cbdceb; color: var(--primary); margin-top: 2px; }
        .country-header { background: #e8eff5; font-size: 0.78rem; padding-left: 20px; border-left: 3px solid var(--accent); }
        .header-stats { font-weight: 900; display: block; margin-top: 4px; font-size: 0.85rem; }
        .collapsible-content { display: none; }
        .open > .collapsible-content { display: block; }
        .plant-card { padding: 12px 15px 12px 30px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.72rem; background: white; position: relative; }
        .loss-badge { background: #E74C3C; color: white; font-weight: bold; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; position: absolute; right: 10px; top: 10px; }
        #update-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 420px; background: white; z-index: 11000; padding: 25px; box-shadow: 0 0 60px rgba(0,0,0,0.6); border-radius: 20px; display: none; }
        #update-modal textarea { width: 100%; height: 180px; margin: 10px 0; font-size: 0.75rem; border: 1px solid #ddd; border-radius: 5px; padding: 8px; box-sizing: border-box; }
        #admin-password { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid var(--primary); border-radius: 8px; box-sizing: border-box; font-weight: bold; font-size: 1rem; text-align: center; }
        #data-input-section { display: none; border-top: 2px dashed #eee; padding-top: 15px; margin-top: 10px; }
        #sync-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 38, 71, 0.97); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; }
        .sync-spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid #FFD700; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .history-container { margin-top: 12px; padding-top: 10px; border-top: 1px dashed var(--accent); }
        .history-title { font-size: 0.75rem; font-weight: 900; color: var(--accent); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.68rem; text-align: left; }
        .history-table th { color: #888; padding: 4px; border-bottom: 1px solid #eee; }
        .history-table td { padding: 6px 4px; border-bottom: 1px solid #f9f9f9; }
        .status-tag { padding: 2px 4px; border-radius: 4px; font-weight: bold; color: white; font-size: 0.6rem; }
        .info-row { display: flex; flex-direction: column; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 4px; }
        .info-label { font-size: 0.65rem; color: #888; font-weight: bold; text-transform: uppercase; }
        .info-value { font-size: 0.9rem; color: #222; font-weight: 700; }
        #chart-panel { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 3000; padding: 20px; box-sizing: border-box; transition: transform 0.3s ease-in-out; transform: translateY(100%); max-height: 50vh; overflow: hidden; display: flex; flex-direction: column; }
        #chart-panel.active { transform: translateY(0); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-chart-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .chart-container { flex-grow: 1; position: relative; }
    </style>
</head>
<body>

<div id="update-modal">
    <div id="auth-section">
        <h3 style="margin-top:0; color:var(--primary);">üîí JS KIM Security</h3>
        <input type="password" id="admin-password" placeholder="Admin Password">
        <button style="background:var(--primary); color:white; padding:12px; width:100%; border:none; border-radius:8px; cursor:pointer; font-weight:900;" onclick="verifyAdmin()">Ïù∏Ï¶ù</button>
    </div>
    <div id="data-input-section">
        <textarea id="csv-input" placeholder="CSV Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî..."></textarea>
        <div style="display: flex; gap: 10px;">
            <button style="flex: 2; background:#27ae60; color:white; padding:15px; border:none; border-radius:10px; cursor:pointer; font-weight:900;" onclick="saveManualData()">Ï†ÄÏû•</button>
            <button style="flex: 1; background:#e67e22; color:white; padding:15px; border:none; border-radius:10px; cursor:pointer; font-weight:900;" onclick="clearManualData()">Ï¥àÍ∏∞Ìôî</button>
        </div>
    </div>
    <button style="width:100%; margin-top:15px; border:none; padding:10px; border-radius:8px; cursor:pointer;" onclick="closeModal()">Îã´Í∏∞</button>
</div>

<div id="sync-overlay">
    <div class="sync-spinner"></div>
    <div id="sync-main-text" style="font-size: 1.8rem; font-weight: 900; margin-bottom: 12px;">ÎèôÍ∏∞Ìôî ÏãúÎèÑ Ï§ë...</div>
    <div style="font-size: 1.1rem; color: #1597BB; font-weight: 500;">Attempting Online Sync...</div>
    <div style="margin-top: 60px; color: #FFD700; font-weight: 900; font-size: 1.5rem;">CREATED BY JS KIM OF LAM</div>
</div>

<div id="layout">
    <div id="sidebar">
        <button id="toggle-btn" onclick="document.getElementById('sidebar').classList.toggle('hidden')">‚ò∞</button>
        <div class="product-tabs">
            <button class="tab-btn active" id="btn-SM" onclick="switchProduct('SM')">SM</button>
            <button class="tab-btn" id="btn-AN" onclick="switchProduct('AN')">AN</button>
            <button class="tab-btn" id="btn-BD" onclick="switchProduct('BD')">BD</button>
        </div>
        <div class="header">
            <span class="created-by">CREATED BY JS KIM OF LAM</span>
            <h1 id="prod-title" onclick="resetToGlobal()" style="margin:0; font-size:1.1rem; cursor:pointer;">Global Supply Control Map</h1>
            <span id="data-mode" onclick="showUpdateModal()">SYNC CHECK</span>
        </div>
        <div class="metrics-grid">
            <div class="metric-box"><span>GLOBAL CAPA</span><span class="metric-value" id="global-val">0</span></div>
            <div class="metric-box"><span>TOTAL SITES</span><span class="metric-value" id="total-sites">0</span></div>
            <div class="metric-box" style="background: #1A1A1B;"><span style="font-size:0.6rem; opacity:0.8; display:block;">CUR. LOSS %</span><span class="metric-value" id="cur-ratio" style="color:#FF4D4D">0.00%</span></div>
            <div class="metric-box" style="background: #D35400;"><span style="font-size:0.6rem; opacity:0.8; display:block;">MONTH LOSS</span><span class="metric-value" id="cur-loss-mt" style="color:#FFD700">0K</span></div>
        </div>
        <div id="list-container">
            <div id="current-risk-group" class="open"><div class="group-header" style="background:var(--current); color:white" onclick="this.parentElement.classList.toggle('open')"><span>‚ö†Ô∏è CURRENT RISK</span><span id="cur-sum-h"></span></div><div class="collapsible-content" id="current-risk-list"></div></div>
            <div id="future-risk-group" class="open"><div class="group-header" style="background:var(--future); color:white" onclick="this.parentElement.classList.toggle('open')"><span>üìÖ FUTURE MAINT</span><span id="fut-sum-h"></span></div><div class="collapsible-content" id="future-risk-list"></div></div>
            <div style="background: var(--primary); color:white; padding:10px 12px; font-size:0.75rem; font-weight:bold; margin-top:10px;">üåê REGIONAL DIRECTORY</div>
            <div id="region-list"></div>
        </div>
    </div>
    <div id="map"></div>
</div>

<div id="chart-panel">
    <div class="chart-header">
        <span class="chart-title" id="chart-country-name">Country Capacity Share</span>
        <button class="close-chart-btn" onclick="closeChartPanel()">√ó</button>
    </div>
    <div class="chart-container"><canvas id="country-chart"></canvas></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const ADMIN_PASS = "jskim0111";
    // ‚îÄ‚îÄ GAS URL (Íµ¨Í∏ÄÏãúÌä∏ ÏßÅÏ†ë Ïó∞Îèô ‚Üí Apps Script Í≤ΩÏú†Î°ú Î≥ÄÍ≤Ω) ‚îÄ‚îÄ
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxjFOXEf9brSrv7rZa-E-sBCXCouKEorZzH-94-j9u-T-CnzfXO36mrNT_C5_6tiZb8/exec';
    const layers = {
        "Standard": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'),
        "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
        "Dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
    };
    const map = L.map('map', {zoomControl: false, zoomAnimation: true}).setView([20, 100], 3);
    layers.Standard.addTo(map); L.control.layers(layers).addTo(map);
   
    let currentProd = 'SM', activeMarkers = [], currentRawData = [], countryChart = null;

    function showUpdateModal() { document.getElementById('admin-password').value = ""; document.getElementById('auth-section').style.display = 'block'; document.getElementById('data-input-section').style.display = 'none'; document.getElementById('update-modal').style.display = 'block'; }
    function closeModal() { document.getElementById('update-modal').style.display = 'none'; }
    function verifyAdmin() { if (document.getElementById('admin-password').value === ADMIN_PASS) { document.getElementById('auth-section').style.display = 'none'; document.getElementById('data-input-section').style.display = 'block'; } else { alert("ÏïîÌò∏ Î∂àÏùºÏπò."); } }
   
    function parseUniversal(text) {
        const lines = text.split("\n").map(l => l.trim()).filter(l => l.length > 0);
        if(lines.length < 2) return [];
        const del = lines[0].includes('\t') ? '\t' : ',';
        const heads = lines[0].split(del).map(h => h.trim().toLowerCase().replace(/\s+/g, '_').replace(/[().]/g, ''));
       
        return lines.slice(1).map(line => {
            const vals = line.split(del); let obj = {};
            heads.forEach((h, i) => {
                let v = vals[i] ? vals[i].trim() : "";
                if(h.includes('capa') || h.includes('kmt')) obj['capacity'] = parseFloat(v.replace(/[^0-9.-]/g, "")) || 0;
                else if(h.includes('lat')) obj['lat'] = parseFloat(v.replace(/[^0-9.-]/g, "")) || 0;
                else if(h.includes('lng') || h.includes('long')) obj['lng'] = parseFloat(v.replace(/[^0-9.-]/g, "")) || 0;
                else if(h.includes('start')) obj['start_date'] = v;
                else if(h.includes('end')) obj['end_date'] = v;
                else if(h.includes('status') || h.includes('remark') || h.includes('rmk')) obj['status'] = v;
                else obj[h] = v;
            });
            if(!obj.company) obj.company = obj.site || obj.plant || "Unknown";
            return obj;
        });
    }

    function flyToTarget(lat, lng, zoom, marker = null) {
        const sidebarWidth = document.getElementById('sidebar').classList.contains('hidden') ? 0 : 320;
        const targetPoint = map.project([lat, lng], zoom).subtract([sidebarWidth / 2, 0]);
        map.flyTo(map.unproject(targetPoint, zoom), zoom, { duration: 1.5 });
        if(marker) map.once('moveend', () => marker.openPopup());
    }

    function cleanDateStr(dStr) {
        if(!dStr || dStr === "" || dStr === null || dStr === undefined) return "";
        // GASÏóêÏÑú Ïà´Ïûê/Date Í∞ùÏ≤¥Î°ú Ïò¨ Ïàò ÏûàÏúºÎØÄÎ°ú Í∞ïÏ†ú Î¨∏ÏûêÏó¥ Î≥ÄÌôò
        var s = String(dStr).trim();
        if(s === "0" || s === "NaN" || s === "undefined" || s === "null") return "";
        return s.replace(/\./g, '-').replace(/\//g, '-').trim();
    }

    function getLossDays(startStr, endStr, mode, isCurrent = false) {
        // GAS JSONÏóêÏÑú Ïò® Í∞íÏùÄ ÌÉÄÏûÖÏù¥ Îã§Î•º Ïàò ÏûàÏúºÎØÄÎ°ú Í∞ïÏ†ú Î¨∏ÏûêÏó¥ Î≥ÄÌôò
        if (startStr === null || startStr === undefined) return 0;
        const startStrSafe = String(startStr).trim();
        const endStrSafe   = endStr !== null && endStr !== undefined ? String(endStr).trim() : "";
        if (!startStrSafe || startStrSafe === "" || startStrSafe === "0") return 0;
       
        const s = cleanDateStr(startStrSafe);
        let e = cleanDateStr(endStrSafe);

        // ÌïµÏã¨: Ï¢ÖÎ£åÏùºÏù¥ ÏóÜÎäîÎç∞ Current Î¶¨Ïä§ÌÅ¨ÎùºÎ©¥ Ïù¥Î≤à Îã¨ ÎßêÏùº(2026-02-28)Î°ú Í∞ïÏ†ú ÏÑ§Ï†ï
        if ((!e || e === "") && isCurrent) {
            e = "2026-02-28";
        } else if (!e || e === "") {
            return 0;
        }

        const pS = new Date(s); const pE = new Date(e);
        if (isNaN(pS) || isNaN(pE)) return 0;
        if (mode === 'total') return Math.max(0, Math.floor((pE - pS) / 86400000) + 1);
       
        const now = new Date(2026, 1, 17);
        const mS = new Date(now.getFullYear(), now.getMonth(), 1);
        const mE = new Date(now.getFullYear(), now.getMonth() + 1, 0);
       
        const iS = new Date(Math.max(mS, pS));
        const iE = new Date(Math.min(mE, pE));
       
        return (iS > iE) ? 0 : Math.floor((iE - iS) / 86400000) + 1;
    }

    function buildHistoryItems(summaryStr) {
        if (!summaryStr || summaryStr === "0") return '<tr><td colspan="4" style="text-align:center; color:#ccc; padding:10px;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</td></tr>';
        const rows = summaryStr.split('|').map(h => {
            const parts = h.split(':'); if (parts[1] && parts[1].includes('1899')) return '';
            const status = (parts[0] || "").trim();
            const statusLower = status.toLowerCase();
            const isWarning = statusLower.includes('shutdown') || statusLower.includes('maintenance') || statusLower.includes('current') || statusLower.includes('trouble');
            return `<tr><td><span class="status-tag" style="background:${isWarning?'#E74C3C':'#27ae60'}">${status}</span></td><td>${parts[1]||'-'}</td><td><b>${parts[2]||'0'}d</b></td><td>${parts[3]||'-'}</td></tr>`;
        }).filter(r => r !== '').join('');
        return rows ? `<table class="history-table"><thead><tr><th>ÏÉÅÌÉú</th><th>ÎÇ†Ïßú</th><th>ÏùºÏàò</th><th>Ï£ºÍ∏∞</th></tr></thead><tbody>${rows}</tbody></table>` : '<tr><td>Í∏∞Î°ùÏóÜÏùå</td></tr>';
    }

    function createPlantCard(p, totalCapa) {
        const capa = parseFloat(p.capacity) || 0;
        const statusStr = (p.status || "").toString();
        const isC = statusStr.toLowerCase().includes('current');
        const mDays = getLossDays(p.start_date, p.end_date, 'month', isC);
        const loss = ((capa / 365) * mDays).toFixed(1);
        const card = document.createElement('div'); card.className = 'plant-card';
        card.innerHTML = `${(mDays>0)?`<span class="loss-badge">${loss}K</span>`:''}<b>${p.company}</b> <span style="color:#1597BB">(${((capa/totalCapa)*100).toFixed(1)}%)</span><div style="color:#666; font-size:0.65rem;">${capa}K | ${p.status||'Normal'}</div>`;
        card.onclick = (e) => { e.stopPropagation(); flyToTarget(p.lat, p.lng, 7, p._m); }; return card;
    }

    function showCountryStats(countryName) {
        const countryData = currentRawData.filter(p => (p.country || "").trim() === countryName && !(p.status && p.status.toString().toLowerCase().includes('deleted')));
        if (countryData.length === 0) return;
        const totalCapa = countryData.reduce((s, p) => s + (parseFloat(p.capacity) || 0), 0);
        const labels = countryData.map(p => p.company);
        const data = countryData.map(p => parseFloat(p.capacity) || 0);
        const ctx = document.getElementById('country-chart').getContext('2d');
        if (countryChart) countryChart.destroy();
        document.getElementById('chart-country-name').innerText = `${countryName} Market Share (Total: ${Math.round(totalCapa).toLocaleString()}K)`;
        document.getElementById('chart-panel').classList.add('active');
        countryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#0A2647', '#1597BB', '#2ECC71', '#F1C40F', '#E74C3C', '#9B59B6', '#34495E', '#95A5A6', '#D35400', '#BDC3C7'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    datalabels: { color: 'white', font: { weight: 'bold', size: 10 }, formatter: (value, ctx) => { let sum = 0; let dataArr = ctx.chart.data.datasets[0].data; dataArr.map(data => { sum += data; }); return (value * 100 / sum).toFixed(1) + "%"; } },
                    legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    async function switchProduct(prod) {
        currentProd = prod;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${prod}`));
        const ovl = document.getElementById('sync-overlay');
        ovl.style.display = 'flex'; ovl.style.opacity = '1';
        document.getElementById('sync-main-text').innerText = `${prod} Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï§ë...`;
        try {
            // GAS URL Í≤ΩÏú†Î°ú Íµ¨Í∏ÄÏãúÌä∏ Îç∞Ïù¥ÌÑ∞ fetch (ÏÇ¨ÎÇ¥ Î≥¥ÏïàÎßù Ïö∞Ìöå)
            const url = GAS_URL + '?action=getAbsData&product=' + prod + '&t=' + new Date().getTime();
            const res = await fetch(url);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const json = await res.json();
            if (json.error) throw new Error(json.error);
            currentRawData = json;
            document.getElementById('sync-main-text').innerText = "‚úÖ GAS Ïó∞Îèô ÏôÑÎ£å!";
        } catch(e) {
            // GAS Ïó∞Îèô Ïã§Ìå® Ïãú ÌîΩÏä§Î™®Îìú ÏïàÎÇ¥
            currentRawData = [];
            document.getElementById('sync-main-text').innerText = "‚ö†Ô∏è Ïó∞Îèô Ïã§Ìå®: " + e.message;
            console.error('GAS fetch Ïò§Î•ò:', e);
        } finally {
            renderEverything(currentRawData);
            setTimeout(() => { ovl.style.opacity = '0'; setTimeout(() => { ovl.style.display = 'none'; }, 600); }, 800);
        }
    }

    function renderEverything(data) {
        activeMarkers.forEach(m => map.removeLayer(m)); activeMarkers = [];
        document.getElementById('current-risk-list').innerHTML='';
        document.getElementById('future-risk-list').innerHTML='';
        document.getElementById('region-list').innerHTML='';
        if (!data || data.length === 0) return;

        const activeData = data.filter(p => !(p.status && p.status.toString().toLowerCase().includes('deleted')));
        const totalGlobalCapa = activeData.reduce((s, p) => s + (parseFloat(p.capacity) || 0), 0);
        document.getElementById('global-val').innerText = Math.round(totalGlobalCapa).toLocaleString();
        document.getElementById('total-sites').innerText = activeData.length;
       
        let totalCurrentLoss = 0;
        const regs = {};

        activeData.forEach(p => {
            if(!p.lat || !p.lng) return;
            const capa = parseFloat(p.capacity) || 0;
            const statusStr = (p.status || "").toString().trim();
            const statusLower = statusStr.toLowerCase();
            const isC = statusLower.includes('current') || statusLower.includes('trouble');
            const isF = statusLower.includes('future') || statusLower.includes('maintenance');
           
            // Ï¢ÖÎ£åÏùº Î∂ÄÏû¨ Ïãú isC Í∏∞Î∞òÏúºÎ°ú 2Ïõî ÎßêÏùºÍπåÏßÄ Í≥ÑÏÇ∞
            const mDays = getLossDays(p.start_date, p.end_date, 'month', isC);
            const tDays = getLossDays(p.start_date, p.end_date, 'total', isC);
            const mLoss = (capa / 365) * mDays;
            const tLoss = (capa / 365) * tDays;
           
            if(isC) totalCurrentLoss += mLoss;

            // ÎßàÏª§ ÌÅ¨Í∏∞ 50% Ï∂ïÏÜå (sqrt * 0.4)
            const markerSize = Math.sqrt(capa) * 0.4;
            let m;
            if (isC || isF) {
                const markerColor = isC ? '#1A1A1B' : '#D35400';
                m = L.marker([p.lat, p.lng], {
                    zIndexOffset: 1000,
                    icon: L.divIcon({
                        html: `<svg width="${markerSize*2.5}" height="${markerSize*2.5}" viewBox="0 0 24 24"><path d="M12 2L2 22H22L12 2Z" fill="${markerColor}" stroke="white" stroke-width="2"/></svg>`,
                        className: 'custom-triangle',
                        iconAnchor: [markerSize*1.25, markerSize*1.25]
                    })
                }).addTo(map);
            } else {
                m = L.circleMarker([p.lat, p.lng], {
                    radius: markerSize, fillColor: '#5DADE2', color: 'white', fillOpacity: 0.9, weight: 1
                }).addTo(map);
            }

            const lossPopupText = (mLoss > 0 || tLoss > 0) ? `<span style="color:#E74C3C"> (M:-${mLoss.toFixed(1)}K / T:-${tLoss.toFixed(1)}K)</span>` : '';
            m.bindPopup(`<div style="min-width:280px; font-family:'Pretendard'; padding:5px;"><div style="font-size:1.1rem; font-weight:900; color:var(--primary); margin-bottom:10px; border-bottom:2px solid var(--accent); padding-bottom:5px;">${p.company}</div><div class="info-row"><span class="info-label">Region / Country</span><span class="info-value">${p.region || '-'} / ${p.country || '-'}</span></div><div class="info-row"><span class="info-label">Status</span><span class="info-value" style="color:#E74C3C; font-weight:900;">${statusStr || 'Normal'} (${p.start_date||''} ~ ${p.end_date||''})</span></div><div class="info-row"><span class="info-label">Capacity (Loss)</span><span class="info-value">${capa.toLocaleString()}K MT${lossPopupText}</span></div><div class="history-container"><div class="history-title">üïí STATUS HISTORY</div>${buildHistoryItems(p.summary || p.history || p.history_data)}</div></div>`);
           
            m.on('click', (e) => { L.DomEvent.stopPropagation(e); flyToTarget(p.lat, p.lng, 7, m); });
            activeMarkers.push(m); p._m = m;

            const pCard = createPlantCard(p, totalGlobalCapa);
            if(isC) document.getElementById('current-risk-list').appendChild(pCard.cloneNode(true)).onclick = pCard.onclick;
            else if(isF) document.getElementById('future-risk-list').appendChild(pCard.cloneNode(true)).onclick = pCard.onclick;

            const r = p.region || "Other", c = p.country || "Other";
            if (!regs[r]) regs[r] = { name: r, countries: {}, totalP: 0, totalC: 0, sLat: 0, sLng: 0 };
            if (!regs[r].countries[c]) regs[r].countries[c] = { name: c, plants: [], cCapa: 0, sLat: 0, sLng: 0 };
            regs[r].countries[c].plants.push(pCard);
            regs[r].countries[c].cCapa += capa;
            regs[r].totalP++; regs[r].totalC += capa; regs[r].sLat += p.lat; regs[r].sLng += p.lng;
        });

        Object.values(regs).sort((a,b) => b.totalP - a.totalP).forEach(r => {
            const rDiv = document.createElement('div');
            rDiv.innerHTML = `<div class="group-header region-header" onclick="this.parentElement.classList.toggle('open'); flyToTarget(${r.sLat/r.totalP}, ${r.sLng/r.totalP}, 4);"><span>${r.name} (${r.totalP}) <span class="header-stats" style="color:#C0392B;">${Math.round(r.totalC).toLocaleString()}K</span></span><span>‚ñº</span></div><div class="collapsible-content"></div>`;
            const rCont = rDiv.querySelector('.collapsible-content');
            Object.values(r.countries).sort((a,b) => b.cCapa - a.cCapa).forEach(c => {
                const cDiv = document.createElement('div');
                cDiv.innerHTML = `<div class="group-header country-header" onclick="this.parentElement.classList.toggle('open');"><span>${c.name} (${c.plants.length}) <span class="header-stats" style="color:#1597BB; cursor:pointer;" onclick="event.stopPropagation(); showCountryStats('${c.name}')">${Math.round(c.cCapa).toLocaleString()}K üìä</span></span><span>‚ñº</span></div><div class="collapsible-content"></div>`;
                const cCont = cDiv.querySelector('.collapsible-content');
                c.plants.forEach(card => cCont.appendChild(card));
                rCont.appendChild(cDiv);
            });
            document.getElementById('region-list').appendChild(rDiv);
        });
       
        const avgMonthlyCapa = totalGlobalCapa / 12;
        document.getElementById('cur-loss-mt').innerText = totalCurrentLoss.toFixed(1) + "K";
        document.getElementById('cur-ratio').innerText = totalGlobalCapa > 0 ? ((totalCurrentLoss / avgMonthlyCapa) * 100).toFixed(2) + "%" : "0.00%";
        document.getElementById('cur-sum-h').innerText = totalCurrentLoss.toFixed(1) + "K ‚ñº";
    }

    function resetToGlobal() { map.flyTo([20, 100], 3, { duration: 1.2 }); }
    function closeChartPanel() { document.getElementById('chart-panel').classList.remove('active'); }
    window.showCountryStats = showCountryStats;
    window.onload = () => switchProduct('SM');
</script>
</body>
</html>
